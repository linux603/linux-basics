

 Step 5: Configure Client VMs

This step ensures that the VMs in your lab can use your BIND DNS server to resolve hostnames.


 1️⃣ Set the DNS server on the client VM

 Goal: Tell the client VM to use your BIND server (`10.128.0.8`) instead of the default DNS (like Google DNS).
 
 Examples :
 ========

a. Ubuntu / Debian (`/etc/resolv.conf` or `netplan`)
--
vi /etc/resolv.conf
 Add the line:
nameserver 10.128.0.8


b. CentOS / RHEL (`/etc/resolv.conf`)
-
vi /etc/resolv.conf
 Add or replace:
nameserver 10.128.0.8


IT Explanation:
 `nameserver 10.128.0.8` tells the client: “Ask this DNS server for all name resolutions.”
 All queries for `.linuxlab.internal` will now go to your BIND server.


 c. Configure your Windows laptop to use the our 10.128.0.8 lab DNS server
 

 1. Via GUI (easy way)
--
1. Open Control Panel → Network and Internet → Network Connections
2. Right-click your active network adapter (Wi-Fi or Ethernet) → Properties
3. Select Internet Protocol Version 4 (TCP/IPv4) → Properties
4. Choose Use the following DNS server addresses
   Preferred DNS server: `34.66.22.100` or 10.128.0.8
5. Click OK to save changes

2.Via Command Line (PowerShell or CMD)
 
    powershell
    Replace "Wi-Fi" with your adapter name
    netsh interface ip set dns "Wi-Fi" static 34.66.22.100 or 10.128.0.8
    netsh interface ip add dns "Wi-Fi" 8.8.8.8 index=2
    

Note : IMP 

 1️⃣ Private Network Use
 Example: Your lab VM `ansible` is in the same private subnet as the DNS server.
 Configure DNS: nameserver 10.128.0.8

 Queries like `ansible.linuxlab.internal` will resolve directly.
 Faster, secure, and no Internet exposure needed.

 2️⃣ Public Network Use
 Example: Your laptop is at home or on a public Wi-Fi.
 Use the public IP: nameserver 34.66.22.100

 Now DNS queries go over the Internet to your lab DNS server.
 Security consideration: your public IP should be firewalled to allow only DNS queries and optionally VPN for safe access.
 Internal hostnames (`.linuxlab.internal`) will be resolvable if the public DNS allows queries.

| Network Type          | IP Address   | When to Use                                                                                                                           |
| ------------------- --| ------------ | --------------------------------------------------------------------------------------------------------------------------------------|
| Private network       | 10.128.0.8   | Use this if your client VM or laptop is inside the same lab/private subnet. Internal VMs can query directly.                          |
| Public network        | 34.66.22.100 | Use this if your laptop is outside the lab, on the Internet or a public network. Access goes through your public IP of the DNS server.|


 3. Test DNS from your Windows laptop

 a. Forward lookup (name → IP), Open Command Prompt or PowerShell:
    nslookup vm1.linuxlab.internal 10.128.0.8
    nslookup ansible.linuxlab.internal 10.128.0.8
    Expected result:
    You should see the internal IP addresses from your BIND zone file.
    Confirms that the laptop can resolve lab hostnames.

 b. Reverse lookup (IP → name)
    nslookup 10.128.0.8
    Returns the hostname of your DNS server (`dns-server.linuxlab.internal`)
    Works if a reverse zone exists in BIND.

 c. Test external DNS (optional)
    nslookup google.com 10.128.0.8




 2️⃣ Test internal DNS resolution

dig stands for Domain Information Groper.
It is a specialized tool for querying DNS servers.
Unlike ping or nslookup, it gives detailed, technical information about how the DNS server responds.


You want to make sure your lab hostnames can be resolved correctly.
Example commands:
dig @10.128.0.8 vm1.linuxlab.internal
dig @10.128.0.8 ansible.linuxlab.internal


Explanation of output:
; <<>> DiG 9.16.1-Ubuntu <<>> @10.128.0.8 vm1.linuxlab.internal
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 12345
;; ANSWER SECTION:
vm1.linuxlab.internal. 86400 IN A 10.128.0.7


 `NOERROR` → The server successfully answered.
 `ANSWER SECTION` → Shows the IP address of `vm1`.
 This proves your internal zone is working.


 3️⃣ Test external DNS resolution (recursion)
If your BIND server allows recursive queries, clients can also resolve Internet domains:


dig @10.128.0.8 google.com


Sample output:
;; ANSWER SECTION:
google.com. 299 IN A 142.250.190.78


IT Explanation:
 Recursive queries mean the DNS server queries other DNS servers on the Internet to resolve names it doesn’t know.
 If recursion is disabled, you will get: status: REFUSED





Ex: Pratical cleint side configuration I have done 

1. I have looged into one of the GCP Hostname/server/clent/vm 

 [root@ansible ~] uname -n
ansible
[root@ansible ~] who am i
linux_lab302 pts/1        2025-12-27 07:35 (35.235.244.33)
[root@ansible ~] date 
Sat Dec 27 07:46:57 AM UTC 2025
[root@ansible ~] 

2. Current DNS resolver
 [root@ansible ~] cat /etc/resolv.conf
 Generated by NetworkManager
search us-central1-f.c.project-a0be8f01-42e0-43d7-ad1.internal c.project-a0be8f01-42e0-43d7-ad1.internal google.internal
nameserver 169.254.169.254
[root@ansible ~] 

Shows that the client is using the default cloud DNS (169.254.169.254).
The search line specifies domains appended automatically for short hostnames.


3. Configured the lab DNS server (`10.128.0.8`) as a secondary/backup nameserver.

[root@ansible ~] cat /etc/resolv.conf
 Generated by NetworkManager
search us-central1-f.c.project-a0be8f01-42e0-43d7-ad1.internal c.project-a0be8f01-42e0-43d7-ad1.internal google.internal
nameserver 169.254.169.254
nameserver 10.128.0.8      your lab BIND server
[root@ansible ~]

Now the client will first query your lab BIND server for internal hostnames.
Queries that the lab server can’t resolve can still fallback to the cloud DNS.


note :

a.Primary DNS :
-----------
The first server listed in your DNS configuration (/etc/resolv.conf on Linux, or Windows DNS settings).
The client queries this server first for all hostname resolutions.
Usually points to the DNS server that is authoritative for your internal domain (lab BIND server in your case).

b.Secondary DNS:
--------------
The next server(s) listed after the primary.
Queried only if the primary fails or does not respond.
Provides redundancy and ensures clients can still resolve names.
Often used for public DNS or backup servers.


Note: IMP concepts 

Redundancy
----------
Means having multiple DNS servers configured so that if one fails, the client can still resolve names.
Ensures continuous operation at the client level.

ex: 
nameserver 10.128.0.8    primary
nameserver 169.254.169.254   secondary

If 10.128.0.8 is down, the client will query the secondary, Redundancy = backup systems to prevent single points of failure.


High Availability (HA)
----------------------
A broader system-level concept. Ensures the service itself remains available even if part of the infrastructure fails.
In DNS, HA usually involves:
Multiple authoritative servers (primary + secondary)
Load balancing or clustering for DNS
Example:
Lab DNS primary (10.128.0.8) + secondary (10.128.0.9) → if one goes down, the other continues to serve DNS queries.
HA = the service itself is resilient, not just the client configuration.

| Concept           | Focus                                               | Example                                                    |
| ----------------- | --------------------------------------------------- | ---------------------------------------------------------- |
| Redundancy        | Client can failover to another DNS if first fails   | `/etc/resolv.conf` lists multiple nameservers              |
| High Availability | Service stays operational even if some servers fail | Multiple authoritative DNS servers with automatic failover |





4. Installing dig :

dig is part of bind-utils and is needed to query DNS servers for testing.
Without it, you cannot perform detailed DNS queries.

[root@ansible ~] dig @10.128.0.8 vm1.linuxlab.internal
-bash: dig: command not found
[root@ansible ~] yum install -y bind-utils
Last metadata expiration check: 0:36:03 ago on Sat 27 Dec 2025 07:03:25 AM UTC.
Dependencies resolved.
===============================================================================================================
 Package                   Architecture        Version                            Repository              Size
===============================================================================================================
Installing:
 bind-utils                x86_64              32:9.18.33-13.el10                 appstream              226 k
Installing dependencies:
 bind-libs                 x86_64              32:9.18.33-13.el10                 appstream              1.3 M
 bind-license              noarch              32:9.18.33-13.el10                 appstream               13 k
 fstrm                     x86_64              0.6.1-12.el10                      appstream               29 k
 libmaxminddb              x86_64              1.9.1-4.el10                       appstream               43 k
 libuv                     x86_64              1:1.51.0-1.el10                    appstream              263 k

Transaction Summary
=

5.Testing DNS resolution

A. Using nslookup
=================

1️⃣ nslookup ansible (without specifying DNS)

[root@ansible ~] nslookup ansible
Server:         169.254.169.254
Address:        169.254.169.25453

Non-authoritative answer:
Name:   ansible.us-central1-f.c.project-a0be8f01-42e0-43d7-ad1.internal
Address: 10.128.0.2

Explanation:
Your client used the default cloud DNS (169.254.169.254).
Cloud DNS knows the VM assigned by the cloud (from DHCP), but it is not authoritative for your lab domain linuxlab.internal.
Non-authoritative answer → The server returned an answer, but it is not the official source.

✅ Works because the hostname exists in the cloud network, not your lab network.


2️⃣ nslookup  ansible.linuxlab.internal (without specifying DNS)

[root@ansible ~] nslookup ansible.linuxlab.internal 
Server:         169.254.169.254
Address:        169.254.169.25453

 server can't find ansible.linuxlab.internal: NXDOMAIN


Note1 : error1 = NXDOMAIN
==========================

What NXDOMAIN means ?? NXDOMAIN stands for Non-Existent Domain. It is a standard DNS response code.
When a DNS server receives a query for a hostname and the domain does not exist in its database, it replies like NXDOMAIN → “The requested domain name does not exist.”


Here  what a Domain Is ? A domain is a logical name that represents a group of computers, services, or resources on a network.
In the Internet or a private network, a domain is like a namespace. It organizes hostnames hierarchically.

what is  Domain Structure ?
A fully qualified domain name (FQDN) looks like this: ansible.linuxlab.internal

| Part       | Meaning                                         |
| ---------- | ----------------------------------------------- |
| `ansible`  | Hostname (the specific machine)                 |
| `linuxlab` | Domain (your lab network)                       |
| `internal` | Top-level domain (TLD) in your lab; not public) |

So here:
 Domain = linuxlab.internal → all hosts in your lab belong to this domain.
 Hostname + Domain = FQDN → `ansible.linuxlab.internal`.

How domains work in DNS ?
 DNS servers are authoritative for specific domains.
 Example:
   Lab DNS (`10.128.0.8`) → authoritative for `linuxlab.internal`
   Cloud DNS (`169.254.169.254`) → authoritative for public/cloud domains
 If a DNS server is not authoritative for a domain, it may return NXDOMAIN.


 Why it happens ?

1. The server is authoritative for the queried domain, but the hostname isn’t defined
    Example: Lab DNS is authoritative for `linuxlab.internal`.
    If you query `vm100.linuxlab.internal` (which doesn’t exist), lab DNS will respond NXDOMAIN.

2. The server is queried for a domain it doesn’t know at all
    Example: Your client queries `ansible.linuxlab.internal` on cloud DNS.
    Cloud DNS is not authoritative for `linuxlab.internal` → replies NXDOMAIN.

   example in your lab :

nslookup ansible.linuxlab.internal
 Default DNS = cloud (`169.254.169.254`)
 Cloud DNS does not know linuxlab.internal
 Response → NXDOMAIN
 Resolver stops → secondary (lab DNS 10.128.0.8) is ignored


In this case we have two way to fix it or test it properly:
----------------------------------------------------------------

a. Force query to lab DNS,  nslookup ansible.linuxlab.internal 10.128.0.8 (way1: test properly)

[root@ansible ~] nslookup ansible.linuxlab.internal 10.128.0.8
Server:         10.128.0.8
Address:        10.128.0.853

Name:   ansible.linuxlab.internal
Address: 10.128.0.2

Explanation:
You explicitly tell the client to use your lab BIND server (10.128.0.8).
now, BIND is authoritative for linuxlab.internal, so it answers correctly with the lab IP.
No NXDOMAIN, and this is the official authoritative answer.

b. Reorder DNS servers in /etc/resolv.conf so lab DNS is first  (way2: fix it )
nameserver 10.128.0.8       primary
nameserver 169.254.169.254  secondary

So, You can list multiple DNS servers in /etc/resolv.conf
--------------------------------------------------------
The system will query the first DNS server in the list.
If the first server does not respond or cannot resolve the domain, it falls back to the next server, and so on.
Typically, you put your internal/lab DNS first for private hostnames, and a public or cloud DNS second for external sites.


Here’s how to fix/update config it step by step:
==================================

1️⃣ Update DNS on the client

 Option A: Temporarily (until reboot)

Edit `/etc/resolv.conf` and make your lab DNS first:

vi /etc/resolv.conf
nameserver 10.128.0.8
nameserver 169.254.169.254    optional secondary for internet
search linuxlab.internal
qw!

Order matters: the first `nameserver` is queried first (your lab DNS).
The second one can be cloud DNS for external Internet queries.

 Option B: Persistently (recommended)

If you’re using NetworkManager:
 Replace <connection-name> with your network interface, e.g., "ens4"
 nmcli con mod <connection-name> ipv4.dns "10.128.0.8 169.254.169.254"
 nmcli con mod <connection-name> ipv4.ignore-auto-dns yes
nmcli con up <connection-name>

 This ensures that every time the VM starts, it uses your lab DNS first

 2️⃣ Test it After updating:

nslookup ansible.linuxlab.internal

Expected output:
Server:         10.128.0.8
Address:        10.128.0.853

Name:   ansible.linuxlab.internal
Address: 10.128.0.2

 Internal hostnames now resolve correctly.
 External DNS queries can still use cloud DNS as fallback if needed.


Note2 : error2 =  timeout
==========================

 we can expect other error : server can't find ansible.linuxlab.internal: timeout


 what is DNS timeout ??
 ------------------------

 A timeout happens when the client sends a query to a DNS server but does not get any response within a certain time (usually a few seconds).
 unlike NXDOMAIN (a valid negative reply), a timeout is “no reply at all.”


 why timeouts can happen ?
 --------------------------

a.DNS server is down or unreachable
he server is powered off or the DNS service is not running.
Example: Your lab DNS at 10.128.0.8 is offline.

b.Network issues between client and DNS server
Firewall blocking UDP/TCP port 53

c.Wrong routing / disconnected network
Server overloaded or unresponsive

d.Server is alive but cannot process requests in time.
DNS query dropped by intermediary

e. Cloud provider, VPN, or NAT drops packets

How the client behaves on timeout ?
------------------------------------
Resolver waits for a response for a few seconds.
If no response → tries the next DNS server in /etc/resolv.conf (secondary).
If all servers fail → query fails completely.


How NXDOMAIN differs from a timeout ?
| Response              | Meaning                | What the client does                                        |
| --------------------- | ---------------------- | ----------------------------------------------------------- |
| NXDOMAIN              | Name does not exist    | Resolver accepts the answer; does not ask secondary DNS     |
| Timeout / unreachable | Server did not respond | Resolver tries the next DNS server (secondary)              |



B. Using dig against lab DNS
=============================

[root@ansible ~] dig @10.128.0.8 ansible.linuxlab.internal

; <<>> DiG 9.18.33 <<>> @10.128.0.8 ansible.linuxlab.internal
; (1 server found)
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 21915
;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 1232
; COOKIE: 8a5e9260c36108af01000000694f8d642e56a51046b1d95d (good)
;; QUESTION SECTION:
;ansible.linuxlab.internal.     IN      A

;; ANSWER SECTION:
ansible.linuxlab.internal. 86400 IN     A       10.128.0.2

;; Query time: 1 msec
;; SERVER: 10.128.0.853(10.128.0.8) (UDP)
;; WHEN: Sat Dec 27 07:40:20 UTC 2025
;; MSG SIZE  rcvd: 98

[root@ansible ~] 


Explanation:

Queries your lab BIND server directly.
ANSWER SECTION shows internal IP from your lab zone file (10.128.0.2).
Flags: aa → authoritative answer from your BIND server.
Confirms internal DNS is working properly.


C. Testing external DNS via lab server
=====================================

[root@ansible ~] dig @10.128.0.8  google.com

; <<>> DiG 9.18.33 <<>> @10.128.0.8 google.com
; (1 server found)
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: SERVFAIL, id: 136
;; flags: qr rd ra; QUERY: 1, ANSWER: 0, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 1232
; COOKIE: 313d0bef64da010101000000694f8ec6a3778d8f8331126b (good)
;; QUESTION SECTION:
;google.com.                    IN      A

;; Query time: 34 msec
;; SERVER: 10.128.0.853(10.128.0.8) (UDP)
;; WHEN: Sat Dec 27 07:46:14 UTC 2025
;; MSG SIZE  rcvd: 67

[root@ansible ~] 


Output explanation :
====================

status: SERVFAIL
-
The server failed to resolve the query.
This happens because your BIND server is authoritative-only for your internal zone (linuxlab.internal) and does not forward or recurse for external Internet domains.

ANSWER: 0
-
No IP addresses were returned because the server cannot resolve external domains.

AUTHORITY: 0 and ADDITIONAL: 1
--
No authority records were provided because it’s not configured to handle external queries.
Additional section shows technical info about the query (EDNS, cookies, etc.).

Query time & SERVER
-
Shows response time and which server responded (10.128.0.8).
Confirms your query reached your lab DNS server.


IT explanation
Authoritative DNS: Knows the IPs for your internal lab hosts (vm1.linuxlab.internal, ansible.linuxlab.internal).
Recursion disabled: Cannot ask other DNS servers (like Google) for Internet names.
This is normal and often intended in labs or secure environments.













