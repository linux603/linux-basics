

 Step 5: Configure Client VMs

This step ensures that the VMs in your lab can use your BIND DNS server to resolve hostnames.


 1️⃣ Set the DNS server on the client VM

 Goal: Tell the client VM to use your BIND server (`10.128.0.8`) instead of the default DNS (like Google DNS).
 
 Examples :
 ========

a. Ubuntu / Debian (`/etc/resolv.conf` or `netplan`)
--
vi /etc/resolv.conf
 Add the line:
nameserver 10.128.0.8


b. CentOS / RHEL (`/etc/resolv.conf`)
-
vi /etc/resolv.conf
 Add or replace:
nameserver 10.128.0.8


IT Explanation:
 `nameserver 10.128.0.8` tells the client: “Ask this DNS server for all name resolutions.”
 All queries for `.linuxlab.internal` will now go to your BIND server.


 c. Configure your Windows laptop to use the our 10.128.0.8 lab DNS server
 ========================================================================

 1. Via GUI (easy way)
--
1. Open Control Panel → Network and Internet → Network Connections
2. Right-click your active network adapter (Wi-Fi or Ethernet) → Properties
3. Select Internet Protocol Version 4 (TCP/IPv4) → Properties
4. Choose Use the following DNS server addresses
    Preferred DNS server: `10.128.0.8` (your BIND DNS server)
    Alternate DNS server: optional (like `8.8.8.8` or cloud DNS for Internet)
5. Click OK to save changes

 2.Via Command Line (PowerShell or CMD)
 -
    powershell
    Replace "Wi-Fi" with your adapter name
    netsh interface ip set dns "Wi-Fi" static 10.128.0.8
    netsh interface ip add dns "Wi-Fi" 8.8.8.8 index=2
    
> This sets the lab DNS as primary and optionally adds a secondary DNS for Internet queries.


 3. Test DNS from your Windows laptop

 a. Forward lookup (name → IP), Open Command Prompt or PowerShell:
    nslookup vm1.linuxlab.internal 10.128.0.8
    nslookup ansible.linuxlab.internal 10.128.0.8
    Expected result:
    You should see the internal IP addresses from your BIND zone file.
    Confirms that the laptop can resolve lab hostnames.

 b. Reverse lookup (IP → name)
    nslookup 10.128.0.8
    Returns the hostname of your DNS server (`dns-server.linuxlab.internal`)
    Works if a reverse zone exists in BIND.

 c. Test external DNS (optional)
    nslookup google.com 10.128.0.8




 2️⃣ Test internal DNS resolution

dig stands for Domain Information Groper.
It is a specialized tool for querying DNS servers.
Unlike ping or nslookup, it gives detailed, technical information about how the DNS server responds.


You want to make sure your lab hostnames can be resolved correctly.
Example commands:
dig @10.128.0.8 vm1.linuxlab.internal
dig @10.128.0.8 ansible.linuxlab.internal


Explanation of output:
; <<>> DiG 9.16.1-Ubuntu <<>> @10.128.0.8 vm1.linuxlab.internal
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 12345
;; ANSWER SECTION:
vm1.linuxlab.internal. 86400 IN A 10.128.0.7


 `NOERROR` → The server successfully answered.
 `ANSWER SECTION` → Shows the IP address of `vm1`.
 This proves your internal zone is working.


 3️⃣ Test external DNS resolution (recursion)
If your BIND server allows recursive queries, clients can also resolve Internet domains:


dig @10.128.0.8 google.com


Sample output:
;; ANSWER SECTION:
google.com. 299 IN A 142.250.190.78


IT Explanation:
 Recursive queries mean the DNS server queries other DNS servers on the Internet to resolve names it doesn’t know.
 If recursion is disabled, you will get: status: REFUSED


Ex: cleint side configuration 

1. I have looged into one of the GCP Hostname/server/clent/vm 

 [root@ansible ~] uname -n
ansible
[root@ansible ~] who am i
linux_lab302 pts/1        2025-12-27 07:35 (35.235.244.33)
[root@ansible ~] date 
Sat Dec 27 07:46:57 AM UTC 2025
[root@ansible ~] 

2. Current DNS resolver
 [root@ansible ~] cat /etc/resolv.conf
 Generated by NetworkManager
search us-central1-f.c.project-a0be8f01-42e0-43d7-ad1.internal c.project-a0be8f01-42e0-43d7-ad1.internal google.internal
nameserver 169.254.169.254
[root@ansible ~] 

Shows that the client is using the default cloud DNS (169.254.169.254).
The search line specifies domains appended automatically for short hostnames.


3.Added lab DNS server (nameserver 10.128.0.8)
 
[root@ansible ~] cat /etc/resolv.conf
 Generated by NetworkManager
search us-central1-f.c.project-a0be8f01-42e0-43d7-ad1.internal c.project-a0be8f01-42e0-43d7-ad1.internal google.internal
nameserver 169.254.169.254
nameserver 10.128.0.8      your lab BIND server
[root@ansible ~]

Now the client will first query your lab BIND server for internal hostnames.
Queries that the lab server can’t resolve can still fallback to the cloud DNS.

4. Installing dig :

dig is part of bind-utils and is needed to query DNS servers for testing.
Without it, you cannot perform detailed DNS queries.

[root@ansible ~] dig @10.128.0.8 vm1.linuxlab.internal
-bash: dig: command not found
[root@ansible ~] yum install -y bind-utils
Last metadata expiration check: 0:36:03 ago on Sat 27 Dec 2025 07:03:25 AM UTC.
Dependencies resolved.
===============================================================================================================
 Package                   Architecture        Version                            Repository              Size
===============================================================================================================
Installing:
 bind-utils                x86_64              32:9.18.33-13.el10                 appstream              226 k
Installing dependencies:
 bind-libs                 x86_64              32:9.18.33-13.el10                 appstream              1.3 M
 bind-license              noarch              32:9.18.33-13.el10                 appstream               13 k
 fstrm                     x86_64              0.6.1-12.el10                      appstream               29 k
 libmaxminddb              x86_64              1.9.1-4.el10                       appstream               43 k
 libuv                     x86_64              1:1.51.0-1.el10                    appstream              263 k

Transaction Summary
=

5.Testing DNS resolution

A. Using nslookup
=================

1️⃣ nslookup ansible (without specifying DNS)

[root@ansible ~] nslookup ansible
Server:         169.254.169.254
Address:        169.254.169.25453

Non-authoritative answer:
Name:   ansible.us-central1-f.c.project-a0be8f01-42e0-43d7-ad1.internal
Address: 10.128.0.2

Explanation:
Your client used the default cloud DNS (169.254.169.254).
Cloud DNS knows the VM assigned by the cloud (from DHCP), but it is not authoritative for your lab domain linuxlab.internal.
Non-authoritative answer → The server returned an answer, but it is not the official source.

✅ Works because the hostname exists in the cloud network, not your lab network.


2️⃣ nslookup  ansible.linuxlab.internal (without specifying DNS)

[root@ansible ~] nslookup ansible.linuxlab.internal 
Server:         169.254.169.254
Address:        169.254.169.25453

 server can't find ansible.linuxlab.internal: NXDOMAIN


Explanation:
Cloud DNS does not know your lab domain (linuxlab.internal).
NXDOMAIN → The name does not exist on this server.
❌ This shows that if you don’t query your lab DNS, internal lab hostnames cannot be resolved.


3️⃣ nslookup ansible.linuxlab.internal 10.128.0.8

[root@ansible ~] nslookup ansible.linuxlab.internal 10.128.0.8
Server:         10.128.0.8
Address:        10.128.0.853

Name:   ansible.linuxlab.internal
Address: 10.128.0.2


Explanation:
You explicitly tell the client to use your lab BIND server (10.128.0.8).
BIND is authoritative for linuxlab.internal, so it answers correctly with the lab IP.
No NXDOMAIN, and this is the official authoritative answer.



why this is happening ?? 
IF your client uses your lab DNS server (`10.128.0.8`) as the primary DNS so it can resolve internal lab hostnames like `ansible.linuxlab.internal`. 
Right now, it’s using the cloud DNS (`169.254.169.254`) by default, which doesn’t know about your lab domain.

Here’s how to fix it step by step:
==================================

1️⃣ Update DNS on the client

 Option A: Temporarily (until reboot)

Edit `/etc/resolv.conf` and make your lab DNS first:

vi /etc/resolv.conf
nameserver 10.128.0.8
nameserver 169.254.169.254    optional secondary for internet
search linuxlab.internal
qw!

Order matters: the first `nameserver` is queried first (your lab DNS).
The second one can be cloud DNS for external Internet queries.

 Option B: Persistently (recommended)

If you’re using NetworkManager:
 Replace <connection-name> with your network interface, e.g., "ens4"
 nmcli con mod <connection-name> ipv4.dns "10.128.0.8 169.254.169.254"
 nmcli con mod <connection-name> ipv4.ignore-auto-dns yes
nmcli con up <connection-name>

 This ensures that every time the VM starts, it uses your lab DNS first.



 2️⃣ Test it After updating:

nslookup ansible.linuxlab.internal

Expected output:
Server:         10.128.0.8
Address:        10.128.0.853

Name:   ansible.linuxlab.internal
Address: 10.128.0.2


 Internal hostnames now resolve correctly.
 External DNS queries can still use cloud DNS as fallback if needed.





B. Using dig against lab DNS
=============================

[root@ansible ~] dig @10.128.0.8 ansible.linuxlab.internal

; <<>> DiG 9.18.33 <<>> @10.128.0.8 ansible.linuxlab.internal
; (1 server found)
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 21915
;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 1232
; COOKIE: 8a5e9260c36108af01000000694f8d642e56a51046b1d95d (good)
;; QUESTION SECTION:
;ansible.linuxlab.internal.     IN      A

;; ANSWER SECTION:
ansible.linuxlab.internal. 86400 IN     A       10.128.0.2

;; Query time: 1 msec
;; SERVER: 10.128.0.853(10.128.0.8) (UDP)
;; WHEN: Sat Dec 27 07:40:20 UTC 2025
;; MSG SIZE  rcvd: 98

[root@ansible ~] 


Explanation:

Queries your lab BIND server directly.
ANSWER SECTION shows internal IP from your lab zone file (10.128.0.2).
Flags: aa → authoritative answer from your BIND server.
Confirms internal DNS is working properly.


C. Testing external DNS via lab server
=====================================

[root@ansible ~] dig @10.128.0.8  google.com

; <<>> DiG 9.18.33 <<>> @10.128.0.8 google.com
; (1 server found)
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: SERVFAIL, id: 136
;; flags: qr rd ra; QUERY: 1, ANSWER: 0, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 1232
; COOKIE: 313d0bef64da010101000000694f8ec6a3778d8f8331126b (good)
;; QUESTION SECTION:
;google.com.                    IN      A

;; Query time: 34 msec
;; SERVER: 10.128.0.853(10.128.0.8) (UDP)
;; WHEN: Sat Dec 27 07:46:14 UTC 2025
;; MSG SIZE  rcvd: 67

[root@ansible ~] 


Output explanation :
====================

status: SERVFAIL
-
The server failed to resolve the query.
This happens because your BIND server is authoritative-only for your internal zone (linuxlab.internal) and does not forward or recurse for external Internet domains.

ANSWER: 0
-
No IP addresses were returned because the server cannot resolve external domains.

AUTHORITY: 0 and ADDITIONAL: 1
--
No authority records were provided because it’s not configured to handle external queries.
Additional section shows technical info about the query (EDNS, cookies, etc.).

Query time & SERVER
-
Shows response time and which server responded (10.128.0.8).
Confirms your query reached your lab DNS server.


IT explanation
Authoritative DNS: Knows the IPs for your internal lab hosts (vm1.linuxlab.internal, ansible.linuxlab.internal).
Recursion disabled: Cannot ask other DNS servers (like Google) for Internet names.
This is normal and often intended in labs or secure environments.
